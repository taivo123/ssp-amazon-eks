
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.4">
    
    
      
        <title>ArgoCD - Amazon EKS SSP Quick Start</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#argo-cd-add-on" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Amazon EKS SSP Quick Start" class="md-header__button md-logo" aria-label="Amazon EKS SSP Quick Start" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon EKS SSP Quick Start
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ArgoCD
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/aws-quickstart/quickstart-ssp-amazon-eks/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-quickstart/quickstart-ssp-amazon-eks
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Amazon EKS SSP Quick Start" class="md-nav__button md-logo" aria-label="Amazon EKS SSP Quick Start" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Amazon EKS SSP Quick Start
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-quickstart/quickstart-ssp-amazon-eks/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-quickstart/quickstart-ssp-amazon-eks
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../core-concepts/" class="md-nav__link">
        Core Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../teams/" class="md-nav__link">
        Teams
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../pipelines/" class="md-nav__link">
        Pipelines
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      <label class="md-nav__link" for="__nav_6">
        AddOns
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="AddOns" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          AddOns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../app-mesh/" class="md-nav__link">
        AWS App Mesh
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          ArgoCD
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        ArgoCD
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-admin-password-from-aws-secrets-manager" class="md-nav__link">
    Setting Admin Password from AWS Secrets Manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrapping" class="md-nav__link">
    Bootstrapping
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#known-issues" class="md-nav__link">
    Known Issues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secrets-support" class="md-nav__link">
    Secrets Support
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functionality" class="md-nav__link">
    Functionality
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../aws-load-balancer-controller/" class="md-nav__link">
        AWS Load Balancer Controller
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-autoscaler/" class="md-nav__link">
        Cluster Autoscaler
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../container-insights/" class="md-nav__link">
        Container Insights
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../external-dns/" class="md-nav__link">
        External DNS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../metrics-server/" class="md-nav__link">
        Metrics Server
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../nginx/" class="md-nav__link">
        Nginx
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ssm-agent/" class="md-nav__link">
        SSM Agent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/weaveworks/weave-gitops-ssp-addon" class="md-nav__link">
        Weave GitOps
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../xray/" class="md-nav__link">
        AWS XRay
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        Cluster Providers
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cluster Providers" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Cluster Providers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-providers/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-providers/ec2-cluster-provider/" class="md-nav__link">
        EC2 Cluster Provider
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-admin-password-from-aws-secrets-manager" class="md-nav__link">
    Setting Admin Password from AWS Secrets Manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrapping" class="md-nav__link">
    Bootstrapping
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#known-issues" class="md-nav__link">
    Known Issues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secrets-support" class="md-nav__link">
    Secrets Support
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functionality" class="md-nav__link">
    Functionality
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-quickstart/quickstart-ssp-amazon-eks/edit/master/docs/addons/argo-cd.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="argo-cd-add-on">Argo CD Add-on<a class="headerlink" href="#argo-cd-add-on" title="Permanent link">&para;</a></h1>
<p><a href="https://argoproj.github.io/argo-cd/">Argo CD</a> is a declarative, GitOps continuous delivery tool for Kubernetes. The Argo CD add-on provisions <a href="https://argoproj.github.io/argo-cd/">Argo CD</a> into an EKS cluster, and can optionally bootstrap your workloads from public and private repositories. This allows platform administrators to combine cluster provisioning and workload bootstrapping in a single step and enable use cases such as replicating an existing running production cluster in a different region in a matter of minutes. This is important for business continuity and disaster recovery cases as well as for cross-regional availability and geographical expansion.</p>
<p>Please see the documentation below for details on automatic boostrapping with ArgoCD add-on. If you prefer manual bootstrapping (once your cluster is deployed with this add-on included), you can find instructions on getting started with Argo CD in our <a href="/getting-started/#deploy-workloads-with-argocd">Getting Started</a> guide.</p>
<p>Full Argo CD project documentation <a href="https://argoproj.github.io/argo-cd/">can be found here</a>.</p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<p>To provision and maintain ArgoCD components without any bootstrapping the add-on allows no-argument constructor to get started. </p>
<div class="highlight"><pre><span></span><code><span class="k">import</span> <span class="p">{</span> <span class="nx">ArgoCDAddOn</span><span class="p">,</span> <span class="nx">ClusterAddOn</span><span class="p">,</span> <span class="nx">EksBlueprint</span> <span class="p">}</span>  <span class="k">from</span> <span class="s1">&#39;@shapirov/cdk-eks-blueprint&#39;</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">argoCDAddOn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArgoCDAddOn</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">addOns</span>: <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">ClusterAddOn</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">argoCDAddOn</span> <span class="p">];</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">App</span><span class="p">();</span>
<span class="k">new</span> <span class="nx">EksBlueprint</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="s1">&#39;my-stack-name&#39;</span><span class="p">,</span> <span class="nx">addOns</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{</span>
  <span class="nx">env</span><span class="o">:</span> <span class="p">{</span>    
      <span class="nx">account</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">AWS_ACCOUNT_ID</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="nx">region</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">AWS_REGION</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div>
<p>The above will use <code>argocd</code> namespace and install all the components. In order to bootstrap workloads you will need to change the default ArgoCD admin password and add repositories as specified in the <a href="https://argoproj.github.io/argo-cd/getting_started/#port-forwarding">Getting Started</a> documentation.</p>
<h2 id="setting-admin-password-from-aws-secrets-manager">Setting Admin Password from AWS Secrets Manager<a class="headerlink" href="#setting-admin-password-from-aws-secrets-manager" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">argoCDAddOn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArgoCDAddOn</span><span class="p">({</span>
    <span class="nx">adminPasswordSecretName</span><span class="o">:</span> <span class="sb">`your-secret-name`</span>
<span class="p">});</span>
<span class="kd">const</span> <span class="nx">addOns</span>: <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">ClusterAddOn</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">argoCDAddOn</span> <span class="p">];</span>
</code></pre></div>
<p>The attribute <code>adminPasswordSecretName</code> is the logical name of the secret in <a href="https://aws.amazon.com/secrets-manager/">AWS Secret Manager</a>. Note, that when deploying to multiple regions, the secret is expected to be replicated to each region. </p>
<p>Inside ArgoCD, the admin password is stored as a <code>bcrypt</code> hash. This step will be performed by the framework and stored in the ArgoCD admin <code>secret</code>. </p>
<p>You can change the admin password through the Secrets Manager, but it will require rerunning the provisioning pipeline. Automatic sync with the Secrets Manager will be added in the future. </p>
<h2 id="bootstrapping">Bootstrapping<a class="headerlink" href="#bootstrapping" title="Permanent link">&para;</a></h2>
<p>The SSP framework provides an approach to bootstrap workloads and/or additional add-ons from a customer GitOps repository. In a general case, the bootstrap GitOps repository may contains an <a href="https://argoproj.github.io/argo-cd/operator-manual/cluster-bootstrapping/#app-of-apps-pattern">App of Apps</a> that points to all workloads and add-ons.  </p>
<p>In order to enable bootstrapping, the add-on allows passing an <code>ArgoApplicationRepository</code> at construction time. The following repository types are supported at present:</p>
<ol>
<li>Public HTTP/HTTPS repositories (e.g., GitHub)</li>
<li>Private HTTPS accessible git repositories requiring username/password authentication.</li>
<li>Private git repositories with SSH access requiring an SSH key for authentication.</li>
<li>Private HTTPS accessible GitHub repositories accessible with GitHub token. </li>
</ol>
<p>The usage example is provided below, along with an approach that could use a separate app of apps to bootstrap workloads in different stages, which is important for a software delivery platform as it allows segregating workloads specific to each stage of the SDLC and defines clear promotion processes through GitOps.</p>
<p><div class="highlight"><pre><span></span><code><span class="k">import</span> <span class="p">{</span> <span class="nx">ArgoCDAddOn</span><span class="p">,</span> <span class="nx">ClusterAddOn</span><span class="p">,</span> <span class="nx">EksBlueprint</span> <span class="p">}</span>  <span class="k">from</span> <span class="s1">&#39;@shapirov/cdk-eks-blueprint&#39;</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">addOns</span> <span class="o">=</span> <span class="p">...;</span>
<span class="kd">const</span> <span class="nx">gitUrl</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/aws-samples/ssp-eks-workloads.git&#39;</span>

<span class="kd">const</span> <span class="nx">devBootstrapArgo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArgoCDAddOn</span><span class="p">({</span>
    <span class="nx">bootstrapRepo</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">repoUrl</span>: <span class="kt">gitUrl</span><span class="p">,</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;envs/dev&#39;</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="kd">const</span> <span class="nx">testBootstrapArgo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArgoCDAddOn</span><span class="p">({</span>
    <span class="nx">bootstrapRepo</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">repoUrl</span><span class="o">:</span> <span class="s1">&#39;git@github.com:aws-samples/ssp-eks-workloads.git&#39;</span><span class="p">,</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;envs/test&#39;</span><span class="p">,</span>
        <span class="nx">credentialsSecretName</span><span class="o">:</span> <span class="s1">&#39;github-ssh-test&#39;</span><span class="p">,</span>
        <span class="nx">credentialsType</span><span class="o">:</span> <span class="s1">&#39;SSH&#39;</span>
    <span class="p">},</span>

<span class="p">});</span>
<span class="kd">const</span> <span class="nx">prodBootstrapArgo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArgoCDAddOn</span><span class="p">({</span>
    <span class="nx">bootstrapRepo</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">repoUrl</span><span class="o">:</span> <span class="s1">&#39;git@github.com:aws-samples/ssp-eks-workloads.git&#39;</span><span class="p">,</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;envs/prod&#39;</span><span class="p">,</span>
        <span class="nx">credentialsSecretName</span><span class="o">:</span> <span class="s1">&#39;github-ssh-test&#39;</span><span class="p">,</span>
        <span class="nx">credentialsType</span><span class="o">:</span> <span class="s1">&#39;SSH&#39;</span>
    <span class="p">},</span>
    <span class="nx">adminPasswordSecretName</span><span class="o">:</span> <span class="s1">&#39;argo-admin-secret&#39;</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">east1</span> <span class="o">=</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">;</span>
<span class="k">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">EksBlueprint</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">east1</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">addOns</span>: <span class="kt">addOns.concat</span><span class="p">(</span><span class="nx">devBootstrapArgo</span><span class="p">),</span> <span class="nx">teams</span> <span class="p">},</span> <span class="p">{</span>
    <span class="nx">env</span><span class="o">:</span> <span class="p">{</span> <span class="nx">region</span>: <span class="kt">east1</span> <span class="p">}</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">east2</span> <span class="o">=</span> <span class="s1">&#39;us-east-2&#39;</span><span class="p">;</span>
<span class="k">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">EksBlueprint</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">east2</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">addOns</span>: <span class="kt">addOns.concat</span><span class="p">(</span><span class="nx">testBootstrapArgo</span><span class="p">),</span> <span class="nx">teams</span> <span class="p">},</span> <span class="p">{</span>
    <span class="nx">env</span><span class="o">:</span> <span class="p">{</span> <span class="nx">region</span>: <span class="kt">east2</span> <span class="p">}</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">west2</span> <span class="o">=</span> <span class="s1">&#39;us-west-2&#39;</span>
<span class="k">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">EksBlueprint</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">west2</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">addOns</span>: <span class="kt">addOns.concat</span><span class="p">(</span><span class="nx">prodBootstrapArgo</span><span class="p">),</span> <span class="nx">teams</span> <span class="p">},</span> <span class="p">{</span>
    <span class="nx">env</span><span class="o">:</span> <span class="p">{</span> <span class="nx">region</span>: <span class="kt">west2</span> <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
The application promotion process in the above example is handled entirely through GitOps. Each stage specific App of Apps contains references to respective application GitOps repository for each stage (e.g referencing the release vs work branches or path-based within individual app GitOps repository).</p>
<h2 id="known-issues">Known Issues<a class="headerlink" href="#known-issues" title="Permanent link">&para;</a></h2>
<ol>
<li>Destruction of the cluster with provisioned applications may cause cloud formation to get stuck on deleting ArgoCD namespace. This happens because the server component that handles Application CRD resource is destroyed before it has a chance to clean up application that were provisioned through GitOps (of which CFN is unaware). To address this issue at the moment, App of Apps application should be destroyed manually before destroying the stack. </li>
<li>Changing the administrator password in the AWS Secrets Manager and rerunning the stack causes login error on ArgoCD UI. This happens due to the fact that Argo Helm rewrites the the secret containing the Dex server API Key (OIDC component of ArgoCD). The workaround at present is to restart the <code>argocd-server</code> pod, which repopulates the token. Secret management aspect of ArgoCD will be improved in the future to not require this step after password change. </li>
</ol>
<h2 id="secrets-support">Secrets Support<a class="headerlink" href="#secrets-support" title="Permanent link">&para;</a></h2>
<p>The framework provides support to supply repository and administrator secrets in AWS Secrets Manager. This support is evolving and will be improved over time as ArgoCD itself matures. </p>
<p><strong>SSH Key Authentication</strong></p>
<ol>
<li>Set <code>credentialsType</code> to <code>SSH</code> when defining <code>ApplicationRepository</code> in the ArgoCD add-on configuration.</li>
<li>Define the secret in AWS Secret Manager as "Plain Text" that contains the private SSH key and (<strong>important</strong>) replicate it to all the desired regions. Please see <a href="https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh">instructions for GitHub</a> on details on setting up SSH access.</li>
</ol>
<p><strong>Username Password and Token Authentication</strong> 
1. Set <code>credentialsType</code> to <code>USERNAME</code> or <code>TOKEN</code> when defining <code>ApplicationRepository</code> in the ArgoCD add-on configuration.
2. Define the secret in the AWS Secret Manager as "Key Value" and set fields <code>username</code> and <code>password</code> to the desired values (clear text). For <code>TOKEN</code> username could be set to any username and password field set to the GitHub token. Replicate to the desired regions.
3. Make sure that for this type of authentication your repository URL is set as <code>https</code>, e.g. https://github.com/aws-samples/ssp-eks-workloads.git.</p>
<p><strong>Admin Secret</strong></p>
<ol>
<li>Create a secret in the AWS Secrets Manager as "Plain Text" and set the value to the desired ArgoCD admin password. </li>
<li>Replicate the secret to all the desired regions.</li>
<li>Set the secret name in <code>adminPasswordSecretName</code> in ArgoCD add-on configuration.</li>
</ol>
<h2 id="functionality">Functionality<a class="headerlink" href="#functionality" title="Permanent link">&para;</a></h2>
<ol>
<li>Creates the namespace specified in the construction parameter (<code>argocd</code> by default).</li>
<li>Deploys the <a href="https://argoproj.github.io/argo-helm"><code>argo-cd</code></a> Helm chart into the cluster.</li>
<li>Allows to specify <code>ApplicationRepository</code> selecting the required authentication method as SSH Key, username/password or username/token. Credentials are expected to be set in AWS Secrets Manager and replicated to the desired region. If bootstrap repository is specified, creates the initial bootstrap application which may be leveraged to bootstrap workloads and/or other add-ons through GitOps.</li>
<li>Allows setting the initial admin password through AWS Secrets Manager, replicating to the desired region. </li>
</ol>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../app-mesh/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              AWS App Mesh
            </div>
          </div>
        </a>
      
      
        <a href="../aws-load-balancer-controller/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              AWS Load Balancer Controller
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.4fa0e4ee.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.1d3bfcf1.min.js"></script>
      
    
  </body>
</html>